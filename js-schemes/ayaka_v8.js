/* 綾香思考音系
 *
 * https://ayaka.shn.hk/v8/
 *
 * @author Ayaka
 */

// 1. 選項

if (!音韻地位) return [
  ['書寫系統', [3, '平假名', '片假名', '日本式羅馬字', '平文式羅馬字'], {
    description: [
      "'平假名': 地 ち",
      "'片假名': 地 チ",
      "'日本式羅馬字': 地 ti",
      "'平文式羅馬字': 地 chi"
    ].join('\n'),
  }],

  ['ヰヱヲ小假名', true, {
    description: ['true: 迥 ク𛅥ィ', 'false: 迥 クヱィ', '僅當開啓假名時生效'].join('\n'),
  }],

  ['音變', [1, {value: null, text: '無'}, '現代日語'], {
    description: [
      "'無': 宙 チウ tiu；南 ダム dam；愁 スウ suu",
      "'現代日語': 宙 チュウ tyuu；南 ダン dan；愁 スウ suu",
    ].join('\n'),
  }],

  // 參考：尉遲治平. 日本悉曇家所傳古漢語調值.
  ['聲調', [1, {value: null, text: '無'}, '四聲', '四聲（數字）', '四聲（調值）', '六聲（調值）', '六聲（符號）', '八聲', '八聲（數字）', '八聲（調值）']],
];

// 2. 輔助函數

const 假名表 = {
  a:  'ア', i:  'イ', u:  'ウ', e:  'エ', o:  'オ',
  ka: 'カ', ki: 'キ', ku: 'ク', ke: 'ケ', ko: 'コ',
  ga: 'ガ', gi: 'ギ', gu: 'グ', ge: 'ゲ', go: 'ゴ',
  sa: 'サ', si: 'シ', su: 'ス', se: 'セ', so: 'ソ',
  za: 'ザ', zi: 'ジ', zu: 'ズ', ze: 'ゼ', zo: 'ゾ',
  ta: 'タ', ti: 'チ', tu: 'ツ', te: 'テ', to: 'ト',
  da: 'ダ', di: 'ヂ', du: 'ヅ', de: 'デ', do: 'ド',
  na: 'ナ', ni: 'ニ', nu: 'ヌ', ne: 'ネ', no: 'ノ',
  pa: 'ハ', pi: 'ヒ', pu: 'フ', pe: 'ヘ', po: 'ホ',
  ba: 'バ', bi: 'ビ', bu: 'ブ', be: 'ベ', bo: 'ボ',
  ma: 'マ', mi: 'ミ', mu: 'ム', me: 'メ', mo: 'モ',
  ya: 'ヤ',           yu: 'ユ',           yo: 'ヨ',
  ra: 'ラ', ri: 'リ', ru: 'ル', re: 'レ', ro: 'ロ',
  wa: 'ワ', wi: 'ヰ',           we: 'ヱ', wo: 'ヲ',
};

const 拗音表 = {
  wya: 'ヰャ', wyo: 'ヰョ',
  ya: 'ャ', yu: 'ュ', yo: 'ョ',
  wa: 'ヮ', wi: '𛅤', we: '𛅥', wo: '𛅦',
};

const 韻尾表 = {
  '': '', i: 'イ', u: 'ウ',
  m: 'ム', n: 'ン', ng: 'ゥ', // ng: 'ィ',
  p: 'フ', t: 'ツ', k: 'ク', // k: 'キ',
};

function roma2kata(s) {
  const r = /^([kgsztdnpbmyrw]?w??[yw]?)([aiueo])([ptkmngiu]*)$/g; // 將音節分為韻頭、主要元音及韻尾
  const match = r.exec(s);
  if (match == null) {
    throw new Error('無法轉換為假名：' + s);
  }
  const { 1: 韻頭, 2: 主要元音, 3: 韻尾 } = match;
  let 假名韻尾 = 韻尾表[韻尾];
  if (主要元音 === 'e') {
    if (韻尾 === 'k') 假名韻尾 = 'キ';
    if (韻尾 === 'ng') 假名韻尾 = 'ィ';
  }
  if (韻頭.length <= 1) {
    return 假名表[韻頭 + 主要元音] + 假名韻尾;
  }
  const 填充元音 = 韻頭[1] === 'w' ? 'u' : 'i'; // 韻頭[1] 只能為 w 或 y
  return 假名表[韻頭[0] + 填充元音] + 拗音表[韻頭.slice(1) + 主要元音] + 假名韻尾;
}

function kata2hira(s) {
  const diff = 'ぁ'.charCodeAt(0) - 'ァ'.charCodeAt(0);
  return [...s].map((c) => ({
    '𛅤': '𛅐',
    '𛅥': '𛅑',
    '𛅦': '𛅒',
  }[c] ?? String.fromCharCode(c.charCodeAt(0) + diff))).join('');
}

function small2large(s) {
  return [...s].map((c) => ({
    '𛅤': 'ヰ',
    '𛅥': 'ヱ',
    '𛅦': 'ヲ',
  }[c] ?? c)).join('');
}

// 3. 推導規則

/** @type { 音韻地位["屬於"] } */
const is = (...x) => 音韻地位.屬於(...x);
/** @type { 音韻地位["判斷"] } */
const when = (...x) => 音韻地位.判斷(...x);

function 聲母規則() {
  return when([
    // 脣音
    ['幫滂並母', 'p'],
    ['明母', [
      ['梗攝 非 (庚耕青韻 入聲)', 'm'],
      ['', 'b'],
    ]],

    // 舌音、半舌音
    ['端透定知徹澄母', 't'],
    ['泥孃母', [
      ['梗攝', 'n'],
      ['', 'd'],
    ]],
    ['來母', 'r'],

    // 齒音、半齒音
    ['精莊章組', 's'],
    ['日母', 'z'],

    // 牙音、喉音
    ['見溪羣曉匣母', 'k'],
    ['疑母', 'g'],
    ['影云以母', '']

  ], '無聲母規則');
}

function 韻母規則() {
  return when([
    // 通攝
    ['東韻 一等', 'ong'],
    ['東韻 三四等', [
      ['幫滂並母', [['舒聲', 'ong'], ['入聲', 'uk']]],
      ['明母', 'ong'],
      ['精莊章組', 'yung'],
      ['舌齒音', [['舒聲', 'yung'], ['入聲', 'ik']]],
      ['牙喉音', [
        ['舒聲', 'yung'],
        ['入聲 影母', 'wik'],
        ['入聲', 'ik']
      ]],
    ]],
    ['冬韻', 'ong'],
    ['鍾韻', [
      ['脣音', 'ong'],
      ['', 'yong'],
    ]],

    // 江攝
    ['江韻', 'ang'],

    // 止攝
    ['止攝', [
      ['脣音', 'i'],
      ['開口', 'i'],
      ['合口', [
        ['舌齒音', 'ui'],
        ['牙喉音', 'wi'],
      ]],
    ]],

    // 遇攝
    ['魚韻', [
      ['莊組', 'o'],
      ['舌齒音', 'yo'],
      ['牙喉音', 'yo'],
    ]],
    ['虞韻', [
      ['脣音', 'u'],
      ['來母', 'u'],
      ['知組', 'yuu'],
      ['莊組', 'u'],
      ['舌齒音', 'yu'],
      ['以母', 'yu'],
      ['牙喉音', 'u'],
    ]],
    ['模韻', [
      ['脣音', 'o'],
      ['舌齒音', 'o'],
      ['影母', 'wo'],
      ['牙喉音', 'o'],
    ]],

    // 蟹攝
    ['祭齊韻', [
      ['脣音', 'ei'],
      ['開口', 'ei'],
      ['合口', 'wei'],
    ]],
    ['蟹攝 一二等', [
      ['脣音', 'ai'],
      ['開口', 'ai'],
      ['合口', 'wai'],
    ]],
    ['廢韻', [
      ['平上聲 章組', 'ai'],
      ['脣音', 'ei'],
      ['開口', 'ei'],
      ['合口', 'wai'],
    ]],

    // 臻攝
    ['真韻', [
      ['脣音', 'in'],
      ['開口', 'in'],
      ['合口', [
        ['來母', 'in'],
        ['莊組', [['舒聲', 'on'], ['', 'it']]],
        ['舌齒音', [['舒聲', 'yun'], ['', 'ot']]],
        ['云母', 'win'],
        ['牙喉音', 'in'],
      ]],
    ]],
    ['臻韻', 'in'],
    ['文韻', 'un'],
    ['殷韻', 'in'],
    ['魂痕韻', 'on'],

    // 山攝
    ['山攝 三四等', [
      ['脣音 C類', 'an'],
      ['脣音', 'en'],
      ['開口', 'en'],
      ['合口', 'wen'],
    ]],
    ['山攝 一二等', [
      ['脣音', 'an'],
      ['開口', 'an'],
      ['合口', 'wan'],
    ]],

    // 效攝
    ['蕭宵韻', 'eu'],
    ['肴韻', 'au'],
    ['豪韻', [
      ['脣音', 'ou'],
      ['舌齒音', 'au'],
      ['牙喉音', 'au'],
    ]],

    // 果攝、假攝
    ['果假攝 一二等', [
      ['脣音', 'a'],
      ['開口', 'a'],
      ['合口', 'wa'],
    ]],
    ['歌韻 三四等', [
      ['脣音', 'a'],
      ['開口', 'ya'],
      ['合口', 'wa'],
    ]],
    ['麻韻 三四等', [
      ['脣音', 'ya'],
      ['開口', 'ya'],
      ['合口', 'wa'],
    ]],

    // 宕攝
    ['陽韻', [
      ['脣音', 'ang'],
      ['開口', [
        ['莊組', 'ang'],
        ['舌齒音', 'yang'],
        ['牙喉音', 'yang'],
      ]],
      ['合口', [
        ['舌齒音', 'ang'],
        ['影云母', 'wang'],
        ['牙喉音', 'wyang'],
      ]],
    ]],
    ['唐韻', [
      ['脣音', 'ang'],
      ['開口', 'ang'],
      ['合口', 'wang'],
    ]],

    // 梗攝
    ['梗攝 二等', [
      ['脣音', 'ang'],
      ['開口', 'ang'],
      ['合口', 'wang'],
    ]],
    ['梗攝 三四等', [
      ['脣音', 'eng'],
      ['開口', 'eng'],
      ['合口', 'weng'],
    ]],

    // 曾攝
    ['蒸韻', [
      ['脣音', 'yong'],
      ['開口', [
        ['莊組', 'ong'],
        ['舌齒音', 'yong'],
        ['牙喉音', 'yong'],
      ]],
      ['合口', [
        ['影云母', 'yong'],
        ['牙喉音', 'wyong'],
      ]],
    ]],
    ['登韻', 'ong'],

    // 流攝
    ['尤韻', [
      ['幫滂並母', 'uu'],
      ['明母', 'ou'],
      ['莊組', 'uu'],
      ['舌齒音', 'iu'],
      ['牙喉音', 'iu'],
    ]],
    ['侯韻', 'ou'],
    ['幽韻', 'iu'],

    // 深攝
    ['侵韻', 'im'],

    // 咸攝
    ['覃談韻', 'am'],
    ['鹽添嚴韻', 'em'],
    ['咸銜凡韻', 'am'],
  ], '無韻母規則');
}

let 聲母 = 聲母規則();
let 韻母 = 韻母規則();

if (is('入聲')) {
  if (韻母.endsWith('m')) 韻母 = 韻母.slice(0, -1) + 'p';
  else if (韻母.endsWith('n')) 韻母 = 韻母.slice(0, -1) + 't';
  else if (韻母.endsWith('ng')) 韻母 = 韻母.slice(0, -2) + 'k';
}

function 聲調規則() {
  if (['四聲', '四聲（數字）', '四聲（調值）'].includes(選項.聲調)) {
    return {
      '平': ['꜀', '1', '11'],
      '上': ['꜂', '2', '55'],
      '去': ['꜄', '3', '15'],
      '入': ['꜆', '4', '1'],
    }[音韻地位.聲][['四聲', '四聲（數字）', '四聲（調值）'].indexOf(選項.聲調)];
  }

  if (選項.聲調 === '六聲（調值）') {
    return when([
      ['平聲 全濁', '11'],
      ['平聲', '51'],
      ['上去聲 全濁', '15'],
      ['上去聲', '55'],
      ['入聲 全濁', '1'],
      ['入聲', '5'],
    ], '無聲調規則');
  }

  if (選項.聲調 === '六聲（符號）') {
    if (is('入聲 全濁')) {
      if (韻母.endsWith('p')) 韻母 = 韻母.slice(0, -1) + 'b';
      else if (韻母.endsWith('t')) 韻母 = 韻母.slice(0, -1) + 'd';
      else if (韻母.endsWith('k')) 韻母 = 韻母.slice(0, -1) + 'g';
      return '';
    }
    return when([
      ['平聲 全濁', 'z'],
      ['平聲', ''],
      ['上去聲 全濁', 'h'],
      ['上去聲', 'x'],
      ['入聲', ''],
    ], '無聲調規則');
  }

  if (['八聲', '八聲（數字）', '八聲（調值）'].includes(選項.聲調)) {
    return [
      { // 陰
        '平': ['꜀', '1', '51'],
        '上': ['꜂', '2', '55'],
        '去': ['꜄', '3', '535'],
        '入': ['꜆', '4', '5'],
      },
      { // 陽
        '平': ['꜁', '5', '11'],
        '上': ['꜃', '6', '15'],
        '去': ['꜅', '7', '315'],
        '入': ['꜇', '8', '1'],
      }
    ][+is`全濁`][音韻地位.聲][['八聲', '八聲（數字）', '八聲（調值）'].indexOf(選項.聲調)];
  }

  return '';
}

let 聲調 = 聲調規則();

if (韻母.startsWith('w') && (!is('牙喉音') || is('A類 或 以母'))) 韻母 = 韻母.slice(1);

// 4. 音變規則

if (選項.音變 === '現代日語') {
  if (韻母.startsWith('w')) 韻母 = 韻母.slice(1); // 園 wen -> en

  if (韻母.endsWith('p')) 韻母 = 韻母.slice(0, -1) + 'u'; // 鄴 gep -> geu
  else if (韻母.endsWith('m')) 韻母 = 韻母.slice(0, -1) + 'n'; // 南 dam -> dan
  else if (韻母.endsWith('eng')) 韻母 = 韻母.slice(0, -2) + 'i'; // 生 seng -> sei
  else if (韻母.endsWith('ng')) 韻母 = 韻母.slice(0, -2) + 'u'; // 相 syang -> syau

  if (韻母.endsWith('au')) 韻母 = 韻母.slice(0, -2) + 'ou'; // 高 kau -> kou
  else if (韻母.endsWith('iu')) 韻母 = 韻母.slice(0, -2) + 'yuu'; // 宙 tiu -> tyuu
  else if (韻母.endsWith('eu')) 韻母 = 韻母.slice(0, -2) + 'you'; // 遙 eu -> you
  else if (韻母.endsWith('ang')) 韻母 = 韻母.slice(0, -3) + 'ong'; // 相 syang -> syong
}

let 聲韻;

if (['平假名', '片假名'].includes(選項.書寫系統)) {
  聲韻 = roma2kata(聲母 + 韻母);
  if (!選項.ヰヱヲ小假名) 聲韻 = small2large(聲韻);
  if (選項.書寫系統 === '平假名') 聲韻 = kata2hira(聲韻);
} else {
  if (選項.音變 === '現代日語') {
    if (聲母 === 'p') 聲母 = 'h'; // 甫 pu -> hu

    if (韻母.endsWith('t')) 韻母 = 韻母 + 'u'; // 遏 at -> atu
    else if (韻母.endsWith('ek')) 韻母 = 韻母 + 'i'; // 席 sek -> seki
    else if (韻母.endsWith('k')) 韻母 = 韻母 + 'u'; // 澤 tak -> taku
  }

  if (選項.書寫系統 === '平文式羅馬字') {
    if (選項.音變 === '現代日語') {
      if (聲母 === 's' && 韻母.startsWith('i')) 聲母 = 'sh'; // 四 si -> shi
      else if (聲母 === 'z' && 韻母.startsWith('i')) 聲母 = 'j'; // 人 zin -> jin
      else if (聲母 === 't' && 韻母.startsWith('i')) 聲母 = 'ch'; // 地 ti -> chi
      else if (聲母 === 't' && 韻母.startsWith('u')) 聲母 = 'ts'; // 追 tui -> tsui
      else if (聲母 === 'h' && 韻母.startsWith('u')) 聲母 = 'f'; // 甫 hu -> fu
      else if (聲母 === 's' && 韻母.startsWith('y')) { 聲母 = 'sh'; 韻母 = 韻母.slice(1); } // 小 syou -> shou
      else if (聲母 === 'z' && 韻母.startsWith('y')) { 聲母 = 'j'; 韻母 = 韻母.slice(1); } // 繞 zyou -> jou
      else if (聲母 === 't' && 韻母.startsWith('y')) { 聲母 = 'ch'; 韻母 = 韻母.slice(1); } // 兆 tyou -> chou

      if (聲母 === 'd' && 韻母.startsWith('i')) 聲母 = 'j'; // 膩 di -> ji
      else if (聲母 === 'd' && 韻母.startsWith('y')) { 聲母 = 'j'; 韻母 = 韻母.slice(1); } // 紐 dyuu -> juu

      if (韻母.endsWith('tu')) 韻母 = 韻母.slice(0, -1) + 'su'; // 遏 atu -> atsu
    }
  }

  聲韻 = 聲母 + 韻母;
}

return [...'꜀꜁꜂꜃'].includes(聲調) ? 聲調 + 聲韻 : 聲韻 + 聲調;
